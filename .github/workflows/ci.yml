name: Constitutional CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

jobs:
  constitutional-enforcement:
    name: Constitutional Enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check
        continue-on-error: false

      - name: Lint (ESLint v9)
        run: npm run lint
        continue-on-error: false

      - name: Format Check (Prettier)
        run: npm run format:check
        continue-on-error: false

  ast-enforcement:
    name: AST Enforcement
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: AST Enforcement Check
        run: npm run ast:check
        continue-on-error: false

      - name: Boundary Validation
        run: npm run boundary:check
        continue-on-error: false

      - name: Client/Server Boundary Check
        run: npm run client-boundary:check
        continue-on-error: false

  design-system-enforcement:
    name: Design System Enforcement
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Design Token Validation
        run: npm run tokens:validate
        continue-on-error: false

      - name: No Design Literals Check
        run: npm run no-design-literals
        continue-on-error: false

      - name: Motion Token Validation
        run: npm run motion:check
        continue-on-error: false

      - name: No Magic Motion Check
        run: npm run no-magic-motion
        continue-on-error: false

  schema-synchronization:
    name: Schema Synchronization
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Zod Schema Sync Check
        run: npm run zod:sync
        continue-on-error: false

  invariant-tests:
    name: Invariant Tests
    runs-on: ubuntu-latest
    needs: [ast-enforcement, design-system-enforcement, schema-synchronization]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Build Application
        run: npm run build

      - name: Run Invariant Tests
        run: npm run test:invariant
        continue-on-error: false

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: test-results/
          retention-days: 7

  bundle-budget:
    name: Bundle Budget Check
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: Check Bundle Size
        run: npm run bundle:check
        continue-on-error: false

      - name: Size Limit Report
        run: npx size-limit --json > size-limit-report.json || true

      - name: Upload Size Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: size-limit-report
          path: size-limit-report.json
          retention-days: 7

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm run test:unit
        continue-on-error: false

      - name: Generate Coverage Report
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: constitutional-enforcement
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Audit Dependencies
        run: npm audit --audit-level=high
        continue-on-error: false

  final-validation:
    name: Final Validation
    runs-on: ubuntu-latest
    needs: [ast-enforcement, design-system-enforcement, schema-synchronization, invariant-tests, bundle-budget, unit-tests, security-audit]
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Constitutional Compliance ✓
        run: |
          echo "╔════════════════════════════════════════════════════════╗"
          echo "║                                                        ║"
          echo "║  ✓ Constitutional Compliance Verified                 ║"
          echo "║                                                        ║"
          echo "║  All enforcement gates passed:                        ║"
          echo "║  ✓ AST Enforcement                                    ║"
          echo "║  ✓ Design System Enforcement                          ║"
          echo "║  ✓ Schema Synchronization                             ║"
          echo "║  ✓ Invariant Tests                                    ║"
          echo "║  ✓ Bundle Budget                                      ║"
          echo "║  ✓ Unit Tests                                         ║"
          echo "║  ✓ Security Audit                                     ║"
          echo "║                                                        ║"
          echo "║  Ready for deployment                                 ║"
          echo "║                                                        ║"
          echo "╚════════════════════════════════════════════════════════╝"
