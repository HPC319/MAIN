#!/usr/bin/env node

/**
 * Production Monitoring Setup Script
 * Generates monitoring configuration for Canonstrata in production
 */

const fs = require('fs');
const path = require('path');

const monitoringConfig = {
  performance: {
    metrics: [
      'FCP', // First Contentful Paint
      'LCP', // Largest Contentful Paint
      'FID', // First Input Delay
      'CLS', // Cumulative Layout Shift
      'TTFB', // Time to First Byte
      'INP', // Interaction to Next Paint
    ],
    thresholds: {
      FCP: 1800, // 1.8s
      LCP: 2500, // 2.5s
      FID: 100, // 100ms
      CLS: 0.1,
      TTFB: 600, // 600ms
      INP: 200, // 200ms
    },
  },
  
  errors: {
    sampleRate: 1.0, // 100% error tracking
    ignoreErrors: [
      'ResizeObserver loop limit exceeded',
      'Non-Error promise rejection captured',
    ],
  },
  
  bundleSize: {
    enabled: true,
    limits: {
      mainBundle: 500 * 1024, // 500KB
      firstLoadJS: 300 * 1024, // 300KB
    },
  },
  
  userExperience: {
    trackAnimations: true,
    trackMotionReduction: true,
    trackRenderingMode: true,
    trackFormIntelligence: true,
  },
  
  designSystem: {
    trackInvariantViolations: true,
    trackMotionIdentity: true,
    trackA11y: true,
  },
};

function generateWebVitalsReporter() {
  return `// Web Vitals Reporter for Canonstrata
// Auto-generated by production monitoring setup

import { onCLS, onFCP, onFID, onLCP, onTTFB, onINP } from 'web-vitals';

interface MetricReport {
  name: string;
  value: number;
  rating: 'good' | 'needs-improvement' | 'poor';
  delta: number;
  id: string;
}

const THRESHOLDS = ${JSON.stringify(monitoringConfig.performance.thresholds, null, 2)};

function getRating(name: string, value: number): 'good' | 'needs-improvement' | 'poor' {
  const threshold = THRESHOLDS[name as keyof typeof THRESHOLDS];
  
  if (name === 'CLS') {
    if (value <= 0.1) return 'good';
    if (value <= 0.25) return 'needs-improvement';
    return 'poor';
  }
  
  if (typeof threshold === 'number') {
    const goodThreshold = threshold * 0.75;
    if (value <= goodThreshold) return 'good';
    if (value <= threshold) return 'needs-improvement';
    return 'poor';
  }
  
  return 'good';
}

function sendToAnalytics(metric: MetricReport) {
  // Send to your analytics service
  if (typeof window !== 'undefined' && (window as any).gtag) {
    (window as any).gtag('event', metric.name, {
      value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
      metric_rating: metric.rating,
      metric_delta: Math.round(metric.delta),
      metric_id: metric.id,
    });
  }

  // Log in development
  if (process.env.NODE_ENV === 'development') {
    const emoji = metric.rating === 'good' ? 'âœ…' : metric.rating === 'needs-improvement' ? 'âš ï¸' : 'âŒ';
    console.log(\`\${emoji} \${metric.name}: \${metric.value.toFixed(2)} (\${metric.rating})\`);
  }
}

export function reportWebVitals() {
  onCLS((metric) => {
    sendToAnalytics({
      name: 'CLS',
      value: metric.value,
      rating: getRating('CLS', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });

  onFCP((metric) => {
    sendToAnalytics({
      name: 'FCP',
      value: metric.value,
      rating: getRating('FCP', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });

  onFID((metric) => {
    sendToAnalytics({
      name: 'FID',
      value: metric.value,
      rating: getRating('FID', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });

  onLCP((metric) => {
    sendToAnalytics({
      name: 'LCP',
      value: metric.value,
      rating: getRating('LCP', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });

  onTTFB((metric) => {
    sendToAnalytics({
      name: 'TTFB',
      value: metric.value,
      rating: getRating('TTFB', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });

  onINP((metric) => {
    sendToAnalytics({
      name: 'INP',
      value: metric.value,
      rating: getRating('INP', metric.value),
      delta: metric.delta,
      id: metric.id,
    });
  });
}
`;
}

function setupMonitoring() {
  console.log('ðŸ”§ Setting up production monitoring for Canonstrata...\n');

  // Create monitoring directory
  const monitoringDir = path.join(process.cwd(), 'src', 'lib', 'monitoring');
  if (!fs.existsSync(monitoringDir)) {
    fs.mkdirSync(monitoringDir, { recursive: true });
    console.log('âœ… Created monitoring directory');
  }

  // Generate web vitals reporter
  const webVitalsPath = path.join(monitoringDir, 'web-vitals.ts');
  fs.writeFileSync(webVitalsPath, generateWebVitalsReporter());
  console.log('âœ… Generated web-vitals.ts');

  // Generate monitoring config
  const configPath = path.join(monitoringDir, 'config.json');
  fs.writeFileSync(configPath, JSON.stringify(monitoringConfig, null, 2));
  console.log('âœ… Generated monitoring config.json');

  // Generate index file
  const indexContent = \`export { reportWebVitals } from './web-vitals';
export { default as monitoringConfig } from './config.json';
\`;
  const indexPath = path.join(monitoringDir, 'index.ts');
  fs.writeFileSync(indexPath, indexContent);
  console.log('âœ… Generated monitoring index.ts');

  console.log('\nðŸ“Š Monitoring setup complete!\n');
  console.log('Next steps:');
  console.log('1. Import { reportWebVitals } from "@/lib/monitoring" in your _app.tsx');
  console.log('2. Call reportWebVitals() to start tracking');
  console.log('3. Configure your analytics service (GA4, Vercel Analytics, etc.)');
  console.log('4. Review thresholds in src/lib/monitoring/config.json\n');
}

// Run if called directly
if (require.main === module) {
  setupMonitoring();
}

module.exports = { setupMonitoring, monitoringConfig };
